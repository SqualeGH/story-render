<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, viewport-fit=cover" />
<title>JackEnVie I.D Esquisses</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#story {
  position: fixed;
  inset: 0;
  background: black;
}

.slide {
  position: absolute;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
}

.slide.active {
  display: flex;
}

.slide img {
  height: 100vh;
  width: auto;
  max-width: 100vw;
  object-fit: contain;
}

/* Progress bar */
#progress {
  position: absolute;
  top: env(safe-area-inset-top);
  left: 0;
  right: 0;
  height: 10px;
  display: flex;
  gap: 6px;
  padding: 10px;
  z-index: 10;
}

.progress-segment {
  flex: 1;
  background: rgba(255,255,255,0.25);
  border-radius: 5px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: white;
}

/* Interaction layer */
#interaction {
  position: absolute;
  inset: 0;
  z-index: 5;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="story">

  <div id="progress"></div>

  <div class="slide active"><img src="media/slide1.jpg"></div>
  <div class="slide"><img src="media/slide2.jpg"></div>
  <div class="slide"><img src="media/slide3.jpg"></div>

  <div id="interaction"></div>

</div>

<script>
const slides = document.querySelectorAll('.slide');
const progress = document.getElementById('progress');
const layer = document.getElementById('interaction');

const durations = [5000, 5000, 5000];

let index = 0;
let timer = null;
let startTime = 0;
let paused = false;

/* Progress bar */
durations.forEach((_, i) => {
  const seg = document.createElement('div');
  seg.className = 'progress-segment';
  seg.innerHTML = '<div class="progress-fill"></div>';
  seg.onclick = () => goTo(i);
  progress.appendChild(seg);
});

function showSlide(i) {
  slides.forEach(s => s.classList.remove('active'));
  slides[i].classList.add('active');

  document.querySelectorAll('.progress-fill').forEach((f, idx) => {
    if (idx < i) f.style.width = '100%';
    if (idx > i) f.style.width = '0%';
  });
}

function startSlide() {
  clearInterval(timer);

  const fill = document.querySelectorAll('.progress-fill')[index];
  fill.style.width = '0%';

  startTime = Date.now();
  paused = false;

  timer = setInterval(() => {
    if (paused) return;

    const elapsed = Date.now() - startTime;
    const percent = Math.min(100, elapsed / durations[index] * 100);
    fill.style.width = percent + '%';

    if (elapsed >= durations[index]) {
      if (index === slides.length - 1) {
        fill.style.width = '100%';
        paused = true;
        clearInterval(timer);
      } else {
        next();
      }
    }
  }, 50);
}

function next() {
  clearInterval(timer);
  if (index < slides.length - 1) {
    index++;
    showSlide(index);
    startSlide();
  }
}

function prev() {
  clearInterval(timer);
  if (index > 0) {
    index--;
    showSlide(index);
    startSlide();
  }
}

function goTo(i) {
  clearInterval(timer);
  index = i;
  showSlide(index);
  startSlide();
}

function togglePause() {
  paused = !paused;
  if (!paused) startTime = Date.now();
}

/* Desktop */
layer.addEventListener('click', e => {
  const mid = window.innerWidth / 2;
  e.clientX > mid ? next() : prev();
});

document.addEventListener('keydown', e => {
  if (e.code === 'Space') {
    e.preventDefault();
    togglePause();
  }
});

/* Mobile gestures — corrected tap logic */
let startX = 0;
let startY = 0;
let longPress = null;
let moved = false;
let tapConsumed = false;

layer.addEventListener('touchstart', e => {
  const t = e.touches[0];
  startX = t.clientX;
  startY = t.clientY;
  moved = false;
  tapConsumed = false;

  longPress = setTimeout(() => {
    paused = true;
    tapConsumed = true;
  }, 300);
}, { passive: true });

layer.addEventListener('touchmove', e => {
  const t = e.touches[0];
  if (Math.abs(t.clientX - startX) > 15 || Math.abs(t.clientY - startY) > 15) {
    moved = true;
    clearTimeout(longPress);
  }
}, { passive: true });

layer.addEventListener('touchend', e => {
  clearTimeout(longPress);

  if (paused) {
    paused = false;
    startTime = Date.now();
    return;
  }

  if (tapConsumed) return;

  const endX = e.changedTouches[0].clientX;
  const dx = endX - startX;

  if (Math.abs(dx) > 40) {
    dx < 0 ? next() : prev();
    return;
  }

  /* Tap zones — reset timer to avoid auto-skip */
  clearInterval(timer);
  const mid = window.innerWidth / 2;
  endX > mid ? next() : prev();
});

/* Init */
showSlide(index);
startSlide();
</script>

</body>
</html>
